name: smart-med-guard

services:
    website-development:
        container_name: smart-med-guard-website-development

        profiles:
            - development

        build:
            context: ./website
            target: development

        env_file:
            - .env

        environment:
            - NEXT_PUBLIC_SERVER_URL=${SERVER_URL}
            - NEXT_PUBLIC_SERVER_WEBSOCKET_URL=${SERVER_WEBSOCKET_URL}
            - NEXT_PUBLIC_SERVER_API_KEY=${SERVER_UNENCRYPTED_API_KEY}

        ports:
            - ${WEBSITE_PORT}:${WEBSITE_PORT}

        depends_on:
            server-development:
                condition: service_healthy

        volumes:
            - ./website/src:/app/src:ro
            - ./website/public:/app/public:ro

        restart: always

        networks:
            - system-network

    website-production:
        container_name: smart-med-guard-website-production

        profiles:
            - production

        build:
            context: ./website
            target: production
            args:
                - NEXT_PUBLIC_SERVER_URL=${SERVER_URL}
                - NEXT_PUBLIC_SERVER_WEBSOCKET_URL=${SERVER_WEBSOCKET_URL}
                - NEXT_PUBLIC_SERVER_API_KEY=${SERVER_UNENCRYPTED_API_KEY}

        env_file:
            - .env

        environment:
            - NEXT_PUBLIC_SERVER_URL=${SERVER_URL}
            - NEXT_PUBLIC_SERVER_WEBSOCKET_URL=${SERVER_WEBSOCKET_URL}
            - NEXT_PUBLIC_SERVER_API_KEY=${SERVER_UNENCRYPTED_API_KEY}

        ports:
            - ${WEBSITE_PORT}:${WEBSITE_PORT}

        depends_on:
            server-production:
                condition: service_healthy

        restart: unless-stopped

        networks:
            - system-network

    server-development:
        container_name: smart-med-guard-server-development

        profiles:
            - development

        build:
            context: ./server
            target: development

        env_file:
            - .env

        environment:
            - LOG_LEVEL=${SERVER_LOG_LEVEL}
            - ENVIRONMENT=development
            - HOST=${SERVER_HOST}
            - PORT=${SERVER_PORT}
            - API_KEY=${SERVER_API_KEY}
            - BCRYPT_SALT_ROUNDS=${SERVER_BCRYPT_SALT_ROUNDS}
            - JWT_SECRET=${SERVER_JWT_SECRET}
            - WEBSOCKET_PORT=${SERVER_WEBSOCKET_PORT}
            - MQTT_HOST=${MQTT_HOST}
            - MQTT_PORT=${MQTT_PORT}
            - POSTGRES_URL=${POSTGRES_URL}

        ports:
            - ${SERVER_PORT}:${SERVER_PORT}
            - ${SERVER_WEBSOCKET_PORT}:${SERVER_WEBSOCKET_PORT}

        depends_on:
            mqtt:
                condition: service_started

            database:
                condition: service_healthy

        volumes:
            - ./server/src:/app/src:ro

        restart: always

        networks:
            - system-network

        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --header='x-api-key: ${SERVER_UNENCRYPTED_API_KEY}' -qO- http://${SERVER_HOST}:${SERVER_PORT} || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 5

    server-production:
        container_name: smart-med-guard-server-production

        profiles:
            - production

        build:
            context: ./server
            target: development

        env_file:
            - .env

        environment:
            - LOG_LEVEL=${SERVER_LOG_LEVEL}
            - ENVIRONMENT=production
            - HOST=${SERVER_HOST}
            - PORT=${SERVER_PORT}
            - API_KEY=${SERVER_API_KEY}
            - BCRYPT_SALT_ROUNDS=${SERVER_BCRYPT_SALT_ROUNDS}
            - JWT_SECRET=${SERVER_JWT_SECRET}
            - WEBSOCKET_PORT=${SERVER_WEBSOCKET_PORT}
            - MQTT_HOST=${MQTT_HOST}
            - MQTT_PORT=${MQTT_PORT}
            - POSTGRES_URL=${POSTGRES_URL}

        ports:
            - ${SERVER_PORT}:${SERVER_PORT}
            - ${SERVER_WEBSOCKET_PORT}:${SERVER_WEBSOCKET_PORT}

        depends_on:
            mqtt:
                condition: service_started

            database:
                condition: service_healthy

        restart: unless-stopped

        networks:
            - system-network

        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --header='x-api-key: ${SERVER_UNENCRYPTED_API_KEY}' -qO- http://${SERVER_HOST}:${SERVER_PORT} || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 5

    mqtt-test-development:
        container_name: smart-med-guard-mqtt-test-development

        profiles:
            - development

        build:
            context: ./mqtt-test
            target: development

        env_file:
            - .env

        environment:
            - MQTT_HOST=${MQTT_HOST}
            - MQTT_PORT=${MQTT_PORT}

        depends_on:
            server-development:
                condition: service_healthy

        volumes:
            - ./mqtt-test/src:/app/src:ro

        restart: always

        networks:
            - system-network

    mqtt:
        image: eclipse-mosquitto:latest

        container_name: smart-med-guard-mqtt

        profiles:
            - development
            - production

        env_file:
            - .env

        ports:
            - ${MQTT_PORT}:${MQTT_PORT}

        volumes:
            - ./mqtt/config:/mosquitto/config
            - ./mqtt/data:/mosquitto/data
            - ./mqtt/log:/mosquitto/log

        networks:
            - system-network

    prisma-studio-development:
        container_name: smart-med-guard-prisma-studio-development

        profiles:
            - development

        build:
            context: ./server
            target: base

        env_file:
            - .env

        environment:
            - POSTGRES_URL=${POSTGRES_URL}

        ports:
            - ${PRISMA_STUDIO_PORT}:${PRISMA_STUDIO_PORT}

        depends_on:
            server-development:
                condition: service_healthy

        command:
            [
                "pnpm",
                "run",
                "prisma:studio",
                "--port",
                "${PRISMA_STUDIO_PORT}:${PRISMA_STUDIO_PORT}",
            ]

        restart: always

        networks:
            - system-network

    prisma-studio-production:
        container_name: smart-med-guard-prisma-studio-production

        profiles:
            - production

        build:
            context: ./server
            target: base

        env_file:
            - .env

        environment:
            - POSTGRES_URL=${POSTGRES_URL}

        ports:
            - ${PRISMA_STUDIO_PORT}:${PRISMA_STUDIO_PORT}

        depends_on:
            server-production:
                condition: service_healthy

        command:
            [
                "pnpm",
                "run",
                "prisma:studio",
                "--port",
                "${PRISMA_STUDIO_PORT}:${PRISMA_STUDIO_PORT}",
            ]

        restart: unless-stopped

        networks:
            - system-network

    database:
        image: postgres:latest

        container_name: smart-med-guard-database

        profiles:
            - development
            - production

        env_file:
            - .env

        environment:
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${POSTGRES_DB}

        ports:
            - ${POSTGRES_PORT}:${POSTGRES_PORT}

        volumes:
            - smart_med_guard_postgres_data:/var/lib/postgresql/data

        networks:
            - system-network

        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5

volumes:
    smart_med_guard_postgres_data:

networks:
    system-network:
        driver: bridge

        driver_opts:
            com.docker.network.bridge.enable_ipv6: "false"
